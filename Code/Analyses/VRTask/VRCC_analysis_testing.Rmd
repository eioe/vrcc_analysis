---
title: "VRCC Analysis - Testing"
author: "AM, FK, PM"
date: "May 5, 2019"
# contact: "klotzsche@cbs.mpg.de", "aleksander.molak@gmail.com", "pawel.motyka@psych.uw.edu.pl"
output: html_document
chunk_output_type: console
self_contained: no
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
basic_color <- '#195e8c'
```

# Import libraries & setup directories & read the data

```{r message=FALSE, warning=FALSE}

# Utils
library(dplyr) 
library(here)
library(tidyr)

# Plotting and tables
library(ggplot2)
library(sjPlot)
library(gghalves)
library(scales)

# Statistical tools
library(lme4)
library(lmtest)
library(lmerTest)
library(car)
library(effsize)
library(psych)
library(equivalence)
library(TOSTER)
library(BayesFactor)

# Set up the fulldata directory
VRCC_dir         <- here()
# Read the preprocessed data
data <- read.csv(file = paste0(VRCC_dir,"/Data/VRTask/VRCC_data_consolidated"))
#data <- read.csv(file = paste0("N:/centralkollegs18/Data/VRTask/VRCC_data_consolidated"))

# convert distances from m to cm
data <- data %>%
mutate(EstimatedDistance = EstimatedDistance * 100, RealDistance = RealDistance * 100, DistanceError = DistanceError * 100 , DistanceErrorAbs = DistanceErrorAbs * 100, LocalizationError = LocalizationError * 100)

```

<br>

# Testing hypothesis 1 (Distance error)

```{r warning=FALSE}

# HYPOTHESIS 1 - Perceived distance to threatening vs non-threatening animals
d <- data %>% 
  group_by(ID) %>%
  summarize(mean_threat     = mean(DistanceError[FearObject == "True"]), 
            mean_non_threat = mean(DistanceError[FearObject == "False"]))
#(!) Distance Error or Distance Error Norm (to be decided)

# check normality of distributions
shapiro.test(d$mean_threat)
shapiro.test(d$mean_non_threat)

# perform paired t-test
t.test(d$mean_threat, d$mean_non_threat, alt = "two.sided", conf = 0.95, paired = T) 

# show summary statistics
describe(d$mean_threat)
describe(d$mean_non_threat)

# for how many subjects threatening closer than non_threatening
d$diff_distances <- d$mean_non_threat - d$mean_threat
length(d$diff_distances[d$diff_distances > 0])
hist(d$diff_distances)
```


# Plot results (hypothesis 1)

```{r}

d <- gather(d, threat, distance_error, mean_threat:mean_non_threat)
d$threat_f[d$threat == "mean_threat"] <- 1
d$threat_f[d$threat == "mean_non_threat"] <- 2
d$pos <- jitter(d$threat_f, amount=.04)

f1 <- ggplot(data = d, aes(y = distance_error)) +
  
  #Add geom_() objects
  geom_point(data = d %>% filter(threat_f =="1"), aes(x = pos), color = 'firebrick3', size = 1.5, 
             alpha = .6) +
  geom_point(data = d %>% filter(threat_f =="2"), aes(x = pos), color = 'dodgerblue3', size = 1.5, 
             alpha = .6) +
  geom_line(aes(x = pos, group = ID), color = 'gray60', alpha = .3) +
  
  geom_half_boxplot(
    data = d %>% filter(threat_f=="1"), aes(x=threat_f, y = distance_error), position = position_nudge(x = -.25), 
    side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
    fill = 'firebrick3') +
  
  geom_half_boxplot(
    data = d %>% filter(threat_f=="2"), aes(x=threat_f, y = distance_error), position = position_nudge(x = .15), 
    side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
    fill = 'dodgerblue3') +
  
  geom_half_violin(
    data = d %>% filter(threat_f=="1"),aes(x = threat_f, y = distance_error), position = position_nudge(x = -.3), 
    side = "l", fill = 'firebrick3') +
  
  geom_half_violin(
    data = d %>% filter(threat_f=="2"),aes(x = threat_f, y = distance_error), position = position_nudge(x= .3), 
    side = "r", fill = "dodgerblue3") +
  #Define additional settings
  scale_x_continuous(breaks=c(1,2), labels=c("Threatening", "Non-threatening")) +
  xlab("Type of animal") + ylab("Distance Error") +
  ggtitle('Threatening vs Non-threatening animals') +
  theme_classic()+
  coord_cartesian(ylim=c(min(d$distance_error), max(d$distance_error)))
f1 # export size: 5 x 5


## Explore results for different animals

d <- data %>% 
  group_by(ID, Stimulus) %>%
  summarize(distance_error = mean(DistanceError))
#(!) Distance Error or Distance Error Norm (to be decided)

d <- spread(d, key = Stimulus, value = distance_error)

boxplot(d$Crocodile, d$FinalWolf, d$FinalSnake, d$Scorpio, d$Deer, d$Pig,  d$Turtle, d$Rabbit, col = c("firebrick3", "firebrick3", "firebrick3", "firebrick3", "dodgerblue3", "dodgerblue3", "dodgerblue3","dodgerblue3"), names = c("crocodile", "wolf", "snake", "scorpio", "deer", "pig", "turtle", "rabbit"))
# export size: 5 x 7

```

# Exploration: distance error as a function of real distance (different animals)

```{r}

for (p in unique(data$Stimulus)) {

subdata <- data[data$Stimulus == p,]

Figure <- ggplot(data = subdata, aes(x = RealDistance, y = DistanceError)) +
  geom_point(col = "grey 15", alpha = 0.2, size = 1, shape = 18) +
  geom_smooth(col = "grey8", method = "loess", level=0.95, alpha = 0.9) +
  labs(y = "Distance Error", x = "True Distance") +
  ggtitle(p) +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 17), axis.text=element_text(size=15),  axis.title=element_text(size=15)) +
  scale_x_continuous(limits= c(min(data$RealDistance), max(data$RealDistance)), expand = c(0.01,0.01)) +
  scale_y_continuous(limits= c(min(data$DistanceError), max(data$DistanceError)), expand = c(0.01,0.01)) + geom_hline(yintercept = 0, col = "royalblue1")

plot(Figure)

}



```


# Exploration: distance error as a function of real distance (overall)

```{r}

# p_errors <- ggplot(data = data, aes(x = RealDistance, y = DistanceError)) +
#   geom_point(col = "grey 30", alpha = 0.3, size = 1.5, shape = 18) +
#   geom_smooth(col = "grey4", method = "loess", level=0.95, alpha = 0.9) +
#   labs(y = "Distance Error", x = "True Distance") +
#   theme_classic() +
#   theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 17), axis.text=element_text(size=15),  axis.title=element_text(size=15)) +
#   scale_x_continuous(limits= c(min(data$RealDistance), max(data$RealDistance)), expand = c(0.01,0.01)) +
#   scale_y_continuous(limits= c(min(data$DistanceError), max(data$DistanceError)), expand = c(0.01,0.01))  + geom_hline(yintercept = 0, col = "blue")
# p_errors
# 
# p_errors_norm <- ggplot(data = data, aes(x = RealDistance, y = DistanceErrorNorm)) + geom_point(col = "grey 30", alpha = 0.3, size = 1.5, shape = 18) +
#   geom_smooth(col = "grey4", method = "loess", level=0.95, alpha = 0.9) +
#   labs(y = "Distance Error", x = "True Distance") +
#   theme_classic() +
#   theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 17), axis.text=element_text(size=15),  axis.title=element_text(size=15)) +
#   scale_x_continuous(limits= c(min(data$RealDistance), max(data$RealDistance)), expand = c(0.01,0.01)) +
#   scale_y_continuous(limits= c(min(data$DistanceErrorNorm), max(data$DistanceErrorNorm)), expand = c(0.01,0.01))  + geom_hline(yintercept = 0, col = "blue")
# p_errors_norm

```



# HYPOTHESIS 2: Perceived distance to threatening animals presented at systole vs presented at diastole (Version B: Distance Error Normalized)

```{r}

# DE ~ CP * Threat + (1 + r true | ID) # full model
# DE ~ 1 + (1 + r true | ID) # null

d <- data[data$c_phase == "systole" | data$c_phase == "diastole",]

full_model <- lmer(DistanceError ~ c_phase * FearObject + (1 + RealDistance|ID), data = d)
summary(full_model)

model1 <- lm(DistanceError ~ c_phase * FearObject, data = d)
summary(model1)

d <- data[data$c_phase == "systole" | data$c_phase == "diastole",]
d <- select(d, ID, DistanceError, c_phase, FearObject)
d <- d %>% group_by(ID, c_phase, FearObject)  %>% summarize(DistanceError = mean(DistanceError))

require(afex, warn.conflicts = FALSE, quietly=TRUE)
#(MEAN)

fit_all <- aov_ez(data = d, dv = "DistanceError", id = "ID", within=c("c_phase", "FearObject"), return = afex_options("return_aov"), anova_table = list(), fun_aggregate = mean)
fit_all 
summary(fit_all) # see epsilon values
ref <- emmeans::emmeans(fit_all, specs = c("c_phase", "FearObject"))
ref
emmeans::contrast(ref,method="pairwise",adjust="bonferroni")

```


# HYPOTHESIS 2: Perceived distance to threatening animals presented at systole vs presented at diastole (Version B: Distance Error Normalized) -

```{r}

# DE ~ CP * Threat + (1 + r true | ID) # full model
# DE ~ 1 + (1 + r true | ID) # null

d <- data[data$c_phase == "systole" | data$c_phase == "diastole",]

full_model <- lmer(DistanceErrorNorm ~ c_phase * FearObject + (1 + RealDistance|ID), data = d)
summary(full_model)

model1 <- lm(DistanceErrorNorm ~ c_phase * FearObject, data = d)
summary(model1)

d <- data[data$c_phase == "systole" | data$c_phase == "diastole",]
d <- dplyr::select(d, ID, DistanceErrorNorm, c_phase, FearObject)
d <- d %>% group_by(ID, c_phase, FearObject)  %>% summarize(DistanceErrorNorm = mean(DistanceErrorNorm))

require(afex, warn.conflicts = FALSE, quietly=TRUE)
#(MEAN)

fit_all <- aov_ez(data = d, dv = "DistanceErrorNorm", id = "ID", within=c("c_phase", "FearObject"), return = afex_options("return_aov"), anova_table = list(), fun_aggregate = mean)
fit_all 
summary(fit_all) # see epsilon values
ref <- emmeans::emmeans(fit_all, specs = c("c_phase", "FearObject"))
ref
emmeans::contrast(ref,method="pairwise",adjust="bonferroni")

```

Plotting binary results

```{r}

# Threatening
d <- data[data$FearObject == "True",]
d <- d[d$c_phase == "systole" | d$c_phase == "diastole", ]

d <- d %>% 
  group_by(ID) %>%
  summarize(m_systole     = mean(DistanceError[c_phase == "systole"]), 
            m_diastole = mean(DistanceError[c_phase == "diastole"]))

d2 <- d
d2$diff <- d$m_diastole - d$m_systole
hist(d2$diff, breaks = 20)
length(d2$diff[d2$diff < 0]) # closer at diastole


d <- gather(d, phase, distance_error, m_systole:m_diastole)
d$phase_f[d$phase == "m_systole"] <- 1
d$phase_f[d$phase == "m_diastole"] <- 2
d$pos <- jitter(d$phase_f, amount=.04)

f1 <- ggplot(data = d, aes(y = distance_error)) +
  
  #Add geom_() objects
  geom_point(data = d %>% filter(phase_f =="1"), aes(x = pos), color = 'firebrick3', size = 1.5, 
             alpha = .6) +
  geom_point(data = d %>% filter(phase_f =="2"), aes(x = pos), color = scales::alpha("firebrick3", 0.5), size = 1.5, 
             alpha = .6) +
  geom_line(aes(x = pos, group = ID), color = 'gray60', alpha = .3) +
  
  geom_half_boxplot(
    data = d %>% filter(phase_f=="1"), aes(x=phase_f, y = distance_error), position = position_nudge(x = -.25), 
    side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
    fill = 'firebrick3') +
  
  geom_half_boxplot(
    data = d %>% filter(phase_f=="2"), aes(x=phase_f, y = distance_error), position = position_nudge(x = .15), 
    side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
    fill = scales::alpha("firebrick3", 0.5)) +
  
  geom_half_violin(
    data = d %>% filter(phase_f=="1"),aes(x = phase_f, y = distance_error), position = position_nudge(x = -.3), 
    side = "l", fill = 'firebrick3') +
  
  geom_half_violin(
    data = d %>% filter(phase_f=="2"),aes(x = phase_f, y = distance_error), position = position_nudge(x= .3), 
    side = "r", fill = scales::alpha("firebrick3", 0.5)) +
  #Define additional settings
  scale_x_continuous(breaks=c(1,2), labels=c("Systole", "Diastole")) +
  xlab("Cardiac phase") + ylab("Distance Error") +
  ggtitle('Threatening animals') +
  theme_classic()+
  coord_cartesian(ylim=c(min(d$distance_error), max(d$distance_error))) +
   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(face="bold",size=12, colour = "black"), axis.text = element_text(face="bold",size=13, colour = "black"))
f1 # export size: 5 x 5

### Non_threatening

d <- data[data$FearObject == "False",]
d <- d[d$c_phase == "systole" | d$c_phase == "diastole", ]

d <- d %>% 
  group_by(ID) %>%
  summarize(m_systole = mean(DistanceError[c_phase == "systole"]), 
            m_diastole = mean(DistanceError[c_phase == "diastole"]))


d2 <- d
d2$diff <- d$m_diastole - d$m_systole
hist(d2$diff, breaks = 20)
length(d2$diff[d2$diff < 0])

d <- gather(d, phase, distance_error, m_systole:m_diastole)
d$phase_f[d$phase == "m_systole"] <- 1
d$phase_f[d$phase == "m_diastole"] <- 2
d$pos <- jitter(d$phase_f, amount=.04)

f2 <- ggplot(data = d, aes(y = distance_error)) +
  
  #Add geom_() objects
  geom_point(data = d %>% filter(phase_f =="1"), aes(x = pos), color = 'dodgerblue3', size = 1.5, 
             alpha = .6) +
  geom_point(data = d %>% filter(phase_f =="2"), aes(x = pos), color = scales::alpha("dodgerblue3", 0.5), size = 1.5, 
             alpha = .6) +
  geom_line(aes(x = pos, group = ID), color = 'gray60', alpha = .3) +
  
  geom_half_boxplot(
    data = d %>% filter(phase_f=="1"), aes(x=phase_f, y = distance_error), position = position_nudge(x = -.25), 
    side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
    fill = 'dodgerblue3') +
  
  geom_half_boxplot(
    data = d %>% filter(phase_f=="2"), aes(x=phase_f, y = distance_error), position = position_nudge(x = .15), 
    side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
    fill = scales::alpha("dodgerblue3", 0.5)) +
  
  geom_half_violin(
    data = d %>% filter(phase_f=="1"),aes(x = phase_f, y = distance_error), position = position_nudge(x = -.3), 
    side = "l", fill = 'dodgerblue3') +
  
  geom_half_violin(
    data = d %>% filter(phase_f=="2"),aes(x = phase_f, y = distance_error), position = position_nudge(x= .3), 
    side = "r", fill = scales::alpha("dodgerblue3", 0.5)) +
  #Define additional settings
  scale_x_continuous(breaks=c(1,2), labels=c("Systole", "Diastole")) +
  xlab("Cardiac phase") + ylab("Distance Error") +
  ggtitle('Non-threatening animals') +
  theme_classic()+
  coord_cartesian(ylim=c(min(d$distance_error), max(d$distance_error))) +
   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(face="bold",size=12, colour = "black"), axis.text = element_text(face="bold",size=13, colour = "black"))
f2 # export size: 5 x 5



```

Null hypothesis testing

```{r}

### Threatening
d <- data[data$FearObject == "True",]
d <- d[d$c_phase == "systole" | d$c_phase == "diastole", ]

# transform data
d <- d %>% 
  group_by(ID) %>%
  summarize(m_systole     = mean(DistanceError[c_phase == "systole"]), 
            m_diastole = mean(DistanceError[c_phase == "diastole"]))

# Contrast of intesrest
shapiro.test(d$m_systole)
shapiro.test(d$m_diastole)
t.test(d$m_systole, d$m_diastole, paired = T)

# TOSTER package

# Implementation #1
cor <- cor.test(d$m_diastole, d$m_systole)
TOSTpaired(n = nrow(d), m1=mean(d$m_systole), m2=mean(d$m_diastole), sd1= sd(d$m_systole), sd2 = sd(d$m_diastole), r12 = cor$estimate , low_eqbound_dz = -0.5, high_eqbound_dz = 0.5, alpha = 0.05, plot = TRUE, verbose = TRUE)

# Implementation #2 (SD - d'cohen)
dataTOSTpaired(data = d, pairs = list(c(i1="m_systole",i2="m_diastole")), low_eqbound = -0.5, high_eqbound = 0.5, eqbound_type = "d", alpha = 0.05, desc = TRUE, plots = TRUE)

# Implementation #2 (raw - cm bounds 2 arbitrary)
dataTOSTpaired(data = d, pairs = list(c(i1="m_systole",i2="m_diastole")), low_eqbound = -2, high_eqbound = 2, eqbound_type = "raw", alpha = 0.05, desc = TRUE, plots = TRUE)

# Bayes Factor package
ttestBF(d$m_systole, d$m_diastole, paired = T)


### Non-threatening
d <- data[data$FearObject == "False",]
d <- d[d$c_phase == "systole" | d$c_phase == "diastole", ]

# transform data
d <- d %>% 
  group_by(ID) %>%
  summarize(m_systole     = mean(DistanceError[c_phase == "systole"]), 
            m_diastole = mean(DistanceError[c_phase == "diastole"]))

# Contrast of intesrest
shapiro.test(d$m_systole)
shapiro.test(d$m_diastole)
t.test(d$m_systole, d$m_diastole, paired = T)

# TOSTER package

# Implementation #1
cor <- cor.test(d$m_diastole, d$m_systole)
TOSTpaired(n = nrow(d), m1=mean(d$m_systole), m2=mean(d$m_diastole), sd1= sd(d$m_systole), sd2 = sd(d$m_diastole), r12 = cor$estimate , low_eqbound_dz = -0.5, high_eqbound_dz = 0.5, alpha = 0.05, plot = TRUE, verbose = TRUE)

# Implementation #2 (SD - d'cohen)
dataTOSTpaired(data = d, pairs = list(c(i1="m_systole",i2="m_diastole")), low_eqbound = -0.5, high_eqbound = 0.5, eqbound_type = "d", alpha = 0.05, desc = TRUE, plots = TRUE)

# Implementation #2 (raw - cm bounds 2 arbitrary)
dataTOSTpaired(data = d, pairs = list(c(i1="m_systole",i2="m_diastole")), low_eqbound = -2, high_eqbound = 2, eqbound_type = "raw", alpha = 0.05, desc = TRUE, plots = TRUE)

# Bayes Factor package
ttestBF(d$m_systole, d$m_diastole, paired = T)


```




Distances to particular animals (cardiac phase split)

```{r}

#d <- data[data$FearObject == "True",]
d <- data[data$c_phase == "systole" | d$c_phase == "diastole", ]

d <- d %>% 
  group_by(ID, Stimulus, c_phase) %>%
  summarize(distance_error = mean(DistanceError))
#(!) Distance Error or Distance Error Norm (to be decided)

d <- spread(d, key = Stimulus, value = distance_error)

d <- pivot_wider(d, names_from = c(c_phase), values_from = c(Scorpio, Crocodile, FinalSnake, FinalWolf))

boxplot(d$Scorpio_systole, d$Scorpio_diastole, ylim = c(-100,100))
t.test(d$Scorpio_systole, d$Scorpio_diastole, paired = T)
boxplot(d$FinalWolf_systole, d$FinalWolf_diastole, ylim = c(-100,100))
t.test(d$FinalWolf_systole, d$FinalWolf_diastole, paired = T)
boxplot(d$FinalSnake_systole, d$FinalSnake_diastole, ylim = c(-100,100))
t.test(d$FinalSnake_systole, d$FinalSnake_diastole, paired = T)
boxplot(d$Crocodile_systole, d$Crocodile_diastole, ylim = c(-100,100))
t.test(d$Crocodile_systole, d$Crocodile_diastole, paired = T)

### DE in relation to real distance
library(colorspace)

d <- data[data$c_phase == "systole" | data$c_phase == "diastole", ]

for (p in unique(d$Stimulus)) {

subdata <- d[d$Stimulus == p,]

Figure <- ggplot(data = subdata, aes(x = RealDistance, y = DistanceError, color = c_phase)) + geom_smooth(method = "loess", level=0.95, alpha = 0.4, aes(fill=c_phase)) +
  labs(y = "Distance Error", x = "Real Distance") +
  ggtitle(p) + scale_color_manual(values = c('systole' = darken("#ff7167", amount = 0.4), 'diastole' = darken("#6a80ff", amount = 0.6))) + scale_fill_manual(values = c('systole' = darken("#ff7167", amount = 0.27), 'diastole' = darken("#6a80ff", amount = 0.65))) +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 17), axis.text=element_text(size=15),  axis.title=element_text(size=15)) +
  scale_x_continuous(limits= c(min(data$RealDistance), max(data$RealDistance)), expand = c(0.01,0.01)) +
  scale_y_continuous(limits= c(-15, 15), expand = c(0.01,0.01)) 

plot(Figure)



}


d <- data %>% 
  group_by(ID) %>%
  summarize(distance_error = mean(DistanceError), RR = mean(RRLength))
scatter.smooth(d$distance_error, d$RR)

scatter.smooth(data$DistanceError, data$RRLength)

for (i in unique(data$ID)) {
  
d <- data[data$ID == i & data$FearObject == "True",]

s <- scatter.smooth(d$RRLength, d$DistanceErrorNorm)
s  
}

```

# EXPLORATORY ANALYSIS: Including R wave (Distances to threatening and non-threatening animals)

```{r}

d <- data[data$c_phase == "systole" | data$c_phase == "diastole" | data$c_phase == "rwave", ]

d <- d %>% 
  group_by(ID, FearObject, c_phase) %>%
  summarize(distance_error = mean(DistanceError))

fit_all <- aov_ez(data = d, dv = "distance_error", id = "ID", within=c("c_phase", "FearObject"), return = afex_options("return_aov"), anova_table = list(), fun_aggregate = mean)
fit_all 
summary(fit_all) # see epsilon values
ref <- emmeans::emmeans(fit_all, specs = c("c_phase", "FearObject"))
ref
emmeans::contrast(ref,method="pairwise",adjust="bonferroni")

dn <- d[d$FearObject == "True",]
boxplot(dn$distance_error[dn$c_phase == "rwave"], dn$distance_error[dn$c_phase == "systole"], dn$distance_error[dn$c_phase == "diastole"], names = c("QRS", "Systole", "Diastole"), main = "Distance error - threatening animals")
dn <- d[d$FearObject == "False",]
boxplot(dn$distance_error[dn$c_phase == "rwave"], dn$distance_error[dn$c_phase == "systole"], dn$distance_error[dn$c_phase == "diastole"], names = c("QRS", "Systole", "Diastole"),  main = "Distance error - non-threatening animals")


```




# EXPLORATORY ANALYSIS: Localization error at different cardiac phases

```{r}
d <- data[data$c_phase == "systole" | data$c_phase == "diastole" | data$c_phase == "rwave",]

d <- select(d, ID, LocalizationError, c_phase)
d <- d %>% group_by(ID, c_phase)  %>% summarize(LocalizationError = mean(LocalizationError))

boxplot(d$LocalizationError[d$c_phase == "rwave"], d$LocalizationError[d$c_phase == "systole"], d$LocalizationError[d$c_phase == "diastole"], names = c("QRS", "Systole", "Diastole"))

fit_all <- aov_ez(data = d, dv = "LocalizationError", id = "ID", within= "c_phase", return = afex_options("return_aov"), anova_table = list(), fun_aggregate = mean)
fit_all 
summary(fit_all) # see epsilon values
ref <- emmeans::emmeans(fit_all, specs = "c_phase")
ref
emmeans::contrast(ref,method="pairwise",adjust="bonferroni")

#normalized LE
d <- data[data$c_phase == "systole" | data$c_phase == "diastole" | data$c_phase == "rwave",]

d <- select(d, ID, LocalizationErrorNorm, c_phase)
d <- d %>% group_by(ID, c_phase)  %>% summarize(LocalizationErrorNorm = mean(LocalizationErrorNorm))

boxplot(d$LocalizationErrorNorm[d$c_phase == "rwave"], d$LocalizationErrorNorm[d$c_phase == "systole"], d$LocalizationErrorNorm[d$c_phase == "diastole"], names = c("QRS", "Systole", "Diastole"))

fit_all <- aov_ez(data = d, dv = "LocalizationErrorNorm", id = "ID", within= "c_phase", return = afex_options("return_aov"), anova_table = list(), fun_aggregate = mean)
fit_all 
summary(fit_all) # see epsilon values
ref <- emmeans::emmeans(fit_all, specs = "c_phase")
ref
emmeans::contrast(ref,method="pairwise",adjust="bonferroni")

## Variance of LE
d <- data[data$c_phase == "systole" | data$c_phase == "diastole" | data$c_phase == "rwave",]

d <- select(d, ID, LocalizationError, c_phase)
d <- d %>% group_by(ID, c_phase)  %>% summarize(LocalizationError = sd(LocalizationError))

boxplot(d$LocalizationError[d$c_phase == "rwave"], d$LocalizationError[d$c_phase == "systole"], d$LocalizationError[d$c_phase == "diastole"], names = c("QRS", "Systole", "Diastole"), ylab = "Variance (sd) - Localization Error")

fit_all <- aov_ez(data = d, dv = "LocalizationError", id = "ID", within= "c_phase", return = afex_options("return_aov"), anova_table = list(), fun_aggregate = mean)
fit_all 
summary(fit_all) # see epsilon values
ref <- emmeans::emmeans(fit_all, specs = "c_phase")
ref
emmeans::contrast(ref,method="pairwise",adjust="bonferroni")
#t.test(d$LocalizationError[d$c_phase == "rwave"], d$LocalizationError[d$c_phase == "systole"], paired = T)

```


# EXPLORATORY ANALYSIS: Localization error for different animals and at different cardiac phases

```{r}

# Two phases
d <- data[data$c_phase == "systole" | data$c_phase == "diastole",]

full_model <- lmer(LocalizationError ~ c_phase * FearObject + (1 + RealDistance|ID), data = d)
summary(full_model)

model1 <- lm(LocalizationError ~ c_phase * FearObject, data = d)
summary(model1)

d <- data[data$c_phase == "systole" | data$c_phase == "diastole",]
d <- select(d, ID, LocalizationError, c_phase, FearObject)
d <- d %>% group_by(ID, c_phase, FearObject)  %>% summarize(LocalizationError = mean(LocalizationError))

require(afex, warn.conflicts = FALSE, quietly=TRUE)
#(MEAN)

fit_all <- aov_ez(data = d, dv = "LocalizationError", id = "ID", within=c("c_phase", "FearObject"), return = afex_options("return_aov"), anova_table = list(), fun_aggregate = mean)
fit_all 
summary(fit_all) # see epsilon values
ref <- emmeans::emmeans(fit_all, specs = c("c_phase", "FearObject"))
ref
emmeans::contrast(ref,method="pairwise",adjust="bonferroni")


# Three phases
d <- data[data$c_phase == "systole" | data$c_phase == "diastole" | data$c_phase == "rwave", ]
d <- select(d, ID, LocalizationError, c_phase, FearObject)
d <- d %>% group_by(ID, c_phase, FearObject)  %>% summarize(LocalizationError = mean(LocalizationError))

require(afex, warn.conflicts = FALSE, quietly=TRUE)
#(MEAN)

fit_all <- aov_ez(data = d, dv = "LocalizationError", id = "ID", within=c("c_phase", "FearObject"), return = afex_options("return_aov"), anova_table = list(), fun_aggregate = mean)
fit_all 
summary(fit_all) # see epsilon values
ref <- emmeans::emmeans(fit_all, specs = c("c_phase", "FearObject"))
ref
emmeans::contrast(ref,method="pairwise",adjust="bonferroni")


```

Plot localization Error at different cardiac phases

```{r}

d <- data[data$FearObject == "True",]
d <- d[d$c_phase == "systole" | d$c_phase == "diastole", ]

d <- d %>% 
  group_by(ID) %>%
  summarize(m_systole     = mean(LocalizationError[c_phase == "systole"]), 
            m_diastole = mean(LocalizationError[c_phase == "diastole"]))

d2 <- d
d2$diff <- d$m_diastole - d$m_systole
hist(d2$diff, breaks = 20)
length(d2$diff[d2$diff < 0]) # closer at diastole

d <- gather(d, phase, localization_error, m_systole:m_diastole)
d$phase_f[d$phase == "m_systole"] <- 1
d$phase_f[d$phase == "m_diastole"] <- 2
d$pos <- jitter(d$phase_f, amount=.04)

fe1 <- ggplot(data = d, aes(y = localization_error)) +
  
  #Add geom_() objects
  geom_point(data = d %>% filter(phase_f =="1"), aes(x = pos), color = 'firebrick3', size = 1.5, 
             alpha = .6) +
  geom_point(data = d %>% filter(phase_f =="2"), aes(x = pos), color = alpha("firebrick3", 0.5), size = 1.5, 
             alpha = .6) +
  geom_line(aes(x = pos, group = ID), color = 'gray60', alpha = .3) +
  
  geom_half_boxplot(
    data = d %>% filter(phase_f=="1"), aes(x=phase_f, y = localization_error), position = position_nudge(x = -.25), 
    side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
    fill = 'firebrick3') +
  
  geom_half_boxplot(
    data = d %>% filter(phase_f=="2"), aes(x=phase_f, y = localization_error), position = position_nudge(x = .15), 
    side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
    fill = alpha("firebrick3", 0.5)) +
  geom_half_violin(
    data = d %>% filter(phase_f=="1"),aes(x = phase_f, y = localization_error), position = position_nudge(x = -.3), 
    side = "l", fill = 'firebrick3') +
  
  geom_half_violin(
    data = d %>% filter(phase_f=="2"),aes(x = phase_f, y = localization_error), position = position_nudge(x= .3), 
    side = "r", fill = alpha("firebrick3", 0.5)) +
  #Define additional settings
  scale_x_continuous(breaks=c(1,2), labels=c("Systole", "Diastole")) +
  xlab("Cardiac phase") + ylab("Localization error") +
  ggtitle('Threatening animals') +
  theme_classic()+
  coord_cartesian(ylim=c(min(d$localization_error), max(d$localization_error))) +
   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(face="bold",size=12, colour = "black"), axis.text = element_text(face="bold",size=13, colour = "black"))
fe1 # export size: 5 x 5

### Non_threatening

d <- data[data$FearObject == "False",]
d <- d[d$c_phase == "systole" | d$c_phase == "diastole", ]

d <- d %>% 
  group_by(ID) %>%
  summarize(m_systole = mean(LocalizationError[c_phase == "systole"]), 
            m_diastole = mean(LocalizationError[c_phase == "diastole"]))

d2 <- d
d2$diff <- d$m_diastole - d$m_systole
hist(d2$diff, breaks = 20)
length(d2$diff[d2$diff < 0])

d <- gather(d, phase, localization_error, m_systole:m_diastole)
d$phase_f[d$phase == "m_systole"] <- 1
d$phase_f[d$phase == "m_diastole"] <- 2
d$pos <- jitter(d$phase_f, amount=.04)

f2 <- ggplot(data = d, aes(y = localization_error)) +
  
  #Add geom_() objects
  geom_point(data = d %>% filter(phase_f =="1"), aes(x = pos), color = 'dodgerblue3', size = 1.5, 
             alpha = .6) +
  geom_point(data = d %>% filter(phase_f =="2"), aes(x = pos), color = alpha("dodgerblue3", 0.5), size = 1.5, 
             alpha = .6) +
  geom_line(aes(x = pos, group = ID), color = 'gray60', alpha = .3) +
  
  geom_half_boxplot(
    data = d %>% filter(phase_f=="1"), aes(x=phase_f, y = localization_error), position = position_nudge(x = -.25), 
    side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
    fill = 'dodgerblue3') +
  
  geom_half_boxplot(
    data = d %>% filter(phase_f=="2"), aes(x=phase_f, y = localization_error), position = position_nudge(x = .15), 
    side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
    fill = alpha("dodgerblue3", 0.5)) +
  
  geom_half_violin(
    data = d %>% filter(phase_f=="1"),aes(x = phase_f, y = localization_error), position = position_nudge(x = -.3), 
    side = "l", fill = 'dodgerblue3') +
  
  geom_half_violin(
    data = d %>% filter(phase_f=="2"),aes(x = phase_f, y = localization_error), position = position_nudge(x= .3), 
    side = "r", fill = alpha("dodgerblue3", 0.5)) +
  #Define additional settings
  scale_x_continuous(breaks=c(1,2), labels=c("Systole", "Diastole")) +
  xlab("Cardiac phase") + ylab("Distance Error") +
  ggtitle('Non-threatening animals') +
  theme_classic()+
  coord_cartesian(ylim=c(min(d$localization_error), max(d$localization_error))) +
   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title = element_text(face="bold",size=12, colour = "black"), axis.text = element_text(face="bold",size=13, colour = "black"))
f2 # export size: 5 x 5


```

Accuracy of estimations - raw data (Cartesian Graphs)

```{r}
library(plotrix)

d <- data
#plt.lns <- seq(d$LocalizationError)
#plt.lns <- d$LocalizationError
#angles <- d$AngleErrDeg
#polar.plot(plt.lns, polar.pos=angles, labels="", rp.type = "polygon")

d <- select(data, ID, FearObject, c_phase, LocalizationError, DistanceError, TruePosition, EstimatedPosition, row_ID)

for (r in unique(d$row_ID)) {
  
true_pos <-  gsub('\\(|\\)', '', d$TruePosition[d$row_ID == r])
true_pos <- unlist(strsplit(true_pos, ","))
d$true_x[d$row_ID == r] <- as.numeric(true_pos[c(1)])
d$true_y[d$row_ID == r] <- as.numeric(true_pos[c(3)])

est_pos <-  gsub('\\(|\\)', '', d$EstimatedPosition[d$row_ID == r])
est_pos <- unlist(strsplit(est_pos, ","))
d$est_x[d$row_ID == r] <- as.numeric(est_pos[c(1)])
d$est_y[d$row_ID == r] <- as.numeric(est_pos[c(3)])

}

d$pos_y <- (d$est_y - d$true_y) * 100
d$pos_x <- (d$est_x - d$true_x) * 100

library(scales)
plot(d$pos_x, d$pos_y, col = scales::alpha("gray40",0.3), cex = 0.1)
abline(v = 0, col = scales::alpha("black", 0.5))
abline(h = 0, col = scales::alpha("black", 0.5))
points(mean(d$pos_x), mean(d$pos_y), col = "gray90", pch = 13)


#d <- d[d$FearObject == "True",]

# Cardiac phase overall
plot(d$pos_x[d$c_phase == "diastole"], d$pos_y[d$c_phase == "diastole"], col = scales::alpha("dodgerblue3",0.2), cex = 0.1, xlim = c(-100,100), ylim = c(-100,100), ylab = "", xlab = "")
abline(v = 0, col = scales::alpha("black", 0.5))
abline(h = 0, col = scales::alpha("black", 0.5))
points(mean(d$pos_x[d$c_phase == "diastole"]), mean(d$pos_y[d$c_phase == "diastole"]), col = "dodgerblue4", pch = 13)

plot(d$pos_x[d$c_phase == "systole"], d$pos_y[d$c_phase == "systole"], col = scales::alpha("firebrick3",0.2), cex = 0.1, xlim = c(-100,100), ylim = c(-100,100), ylab = "", xlab = "")
abline(v = 0, col = scales::alpha("black", 0.5))
abline(h = 0, col = scales::alpha("black", 0.5))
points(mean(d$pos_x[d$c_phase == "systole"]), mean(d$pos_y[d$c_phase == "systole"]), col = "firebrick4", pch = 13)

mean(d$pos_y[d$c_phase == "systole"])
mean(d$pos_y[d$c_phase == "diastole"])
mean(d$pos_x[d$c_phase == "systole"])
mean(d$pos_x[d$c_phase == "diastole"])

sd(d$pos_y[d$c_phase == "systole"])
sd(d$pos_y[d$c_phase == "diastole"])
sd(d$pos_x[d$c_phase == "systole"])
sd(d$pos_x[d$c_phase == "diastole"])


# Fear object
plot(d$pos_x[d$FearObject == "True"], d$pos_y[d$FearObject == "True"], col = scales::alpha("darkorange",0.2), cex = 0.1, xlim = c(-100,100), ylim = c(-100,100), xlab = "", ylab = "")
abline(v = 0, col = scales::alpha("black", 0.5))
abline(h = 0, col = scales::alpha("black", 0.5))
points(d$pos_x[d$FearObject == "False"], d$pos_y[d$FearObject == "False"], col = scales::alpha("lightgreen",0.2), cex = 0.1)
points(mean(d$pos_x[d$FearObject == "True"]), mean(d$pos_y[d$FearObject == "True"]), col = "darkorange", pch = 13)
points(mean(d$pos_x[d$FearObject == "False"]), mean(d$pos_y[d$FearObject == "False"]), col = "darkgreen", pch = 13)

mean(d$pos_y[d$FearObject == "True"])
mean(d$pos_y[d$FearObject == "False"])
sd(d$pos_y[d$FearObject == "True"])
sd(d$pos_y[d$FearObject == "False"])


```

Accuracy of estimations - subject level

```{r}

d <- d %>% 
  group_by(ID, FearObject, c_phase) %>%
  summarize(pos_x = mean(pos_x), pos_y = mean(pos_y))

d <- d[d$c_phase!= "buffer",]

Ts <- d[d$FearObject == "True" & d$c_phase == "systole",]
Td <- d[d$FearObject == "True" & d$c_phase == "diastole",]
Tr <- d[d$FearObject == "True" & d$c_phase == "rwave",]

plot(Ts$pos_x, Ts$pos_y, col = scales::alpha("firebrick3",0.7), cex = 0.4, xlim = c(-15,15), ylim = c(-100,100), xlab = "", ylab = "", pch = 20)
abline(v = 0, col = scales::alpha("black", 0.5))
abline(h = 0, col = scales::alpha("black", 0.5))
points(mean(Ts$pos_x), mean(Ts$pos_y), pch = 13, col = "firebrick4")
points(Tr$pos_x, Tr$pos_y, col = scales::alpha("darkgoldenrod2",0.7), cex = 0.4,  pch = 20)
points(mean(Tr$pos_x), mean(Tr$pos_y), pch = 13, col = "darkgoldenrod2")
points(Td$pos_x, Td$pos_y, col = scales::alpha("dodgerblue3",0.7), cex = 0.4,  pch = 20)
points(mean(Td$pos_x), mean(Td$pos_y), pch = 13, col = "dodgerblue4")


NTs <- d[d$FearObject == "False" & d$c_phase == "systole",]
NTd <- d[d$FearObject == "False" & d$c_phase == "diastole",]
NTr <- d[d$FearObject == "False" & d$c_phase == "rwave",]
plot(NTs$pos_x, NTs$pos_y, col = scales::alpha("firebrick3",0.7), cex = 0.4, xlim = c(-15,15), ylim = c(-100,100), xlab = "", ylab = "", pch = 20)
abline(v = 0, col = scales::alpha("black", 0.5))
abline(h = 0, col = scales::alpha("black", 0.5))
points(mean(NTs$pos_x), mean(NTs$pos_y), pch = 13, col = "firebrick4")
points(NTr$pos_x, NTr$pos_y, col = scales::alpha("darkgoldenrod2",0.7), cex = 0.4,  pch = 20)
points(mean(NTr$pos_x), mean(NTr$pos_y), pch = 13, col = "darkgoldenrod2")
points(NTd$pos_x, NTd$pos_y, col = scales::alpha("dodgerblue3",0.7), cex = 0.4,  pch = 20)
points(mean(NTd$pos_x), mean(NTd$pos_y), pch = 13, col = "dodgerblue4")


### VARIANCE (sd) instead of means # re-run calculation of "d" in the chunk above
d <- d %>% 
  group_by(ID, FearObject, c_phase) %>%
  summarize(pos_x = sd(pos_x), pos_y = sd(pos_y))

# Threatening
Ts <- d[d$FearObject == "True" & d$c_phase == "systole",]
Td <- d[d$FearObject == "True" & d$c_phase == "diastole",]
Tr <- d[d$FearObject == "True" & d$c_phase == "rwave",]

plot(Ts$pos_x, Ts$pos_y, col = scales::alpha("firebrick3",0.7), cex = 0.4, xlim = c(5,25), ylim = c(20,90), xlab = "Mean variance (sd) - x axis", ylab = "Mean variance (sd) - y axis", pch = 20)
points(mean(Ts$pos_x), mean(Ts$pos_y), pch = 13, col = "firebrick4")
points(Tr$pos_x, Tr$pos_y, col = scales::alpha("darkgoldenrod2",0.7), cex = 0.4,  pch = 20)
points(mean(Tr$pos_x), mean(Tr$pos_y), pch = 13, col = "darkgoldenrod2")
points(Td$pos_x, Td$pos_y, col = scales::alpha("dodgerblue3",0.7), cex = 0.4,  pch = 20)
points(mean(Td$pos_x), mean(Td$pos_y), pch = 13, col = "dodgerblue4")

# Non-threatening (caution: same naming left)
Ts <- d[d$FearObject == "False" & d$c_phase == "systole",]
Td <- d[d$FearObject == "False" & d$c_phase == "diastole",]
Tr <- d[d$FearObject == "False" & d$c_phase == "rwave",]

plot(Ts$pos_x, Ts$pos_y, col = scales::alpha("firebrick3",0.7), cex = 0.4, xlim = c(5,25), ylim = c(20,90), xlab = "Mean variance (sd) - x axis", ylab = "Mean variance (sd) - y axis", pch = 20)
points(mean(Ts$pos_x), mean(Ts$pos_y), pch = 13, col = "firebrick4")
points(Tr$pos_x, Tr$pos_y, col = scales::alpha("darkgoldenrod2",0.7), cex = 0.4,  pch = 20)
points(mean(Tr$pos_x), mean(Tr$pos_y), pch = 13, col = "darkgoldenrod2")
points(Td$pos_x, Td$pos_y, col = scales::alpha("dodgerblue3",0.7), cex = 0.4,  pch = 20)
points(mean(Td$pos_x), mean(Td$pos_y), pch = 13, col = "dodgerblue4")


```



MORE COMPLEX PLOT FOR H2 (NOT WORKING YET or probably will not be used anyway)

```{r}

d <- data %>% 
  group_by(ID) %>%
  summarize(threat_systole   = mean(DistanceError[FearObject == "True" & c_phase == "systole"]), 
            threat_diastole = mean(DistanceError[FearObject == "True" & c_phase == "diastole"]),
            nonthreat_systole   = mean(DistanceError[FearObject == "False" & c_phase == "systole"]), 
            nonthreat_diastole = mean(DistanceError[FearObject == "False"  & c_phase == "diastole"]))



library(tidyr)
d <- gather(d, condition, distance_error, threat_systole:nonthreat_diastole)
d$cond[d$condition == "threat_systole"] <- 1
d$cond[d$condition == "threat_diastole"] <- 2
d$cond[d$condition == "nonthreat_systole"] <- 3
d$cond[d$condition == "nonthreat_diastole"] <- 4
d$xj <- jitter(d$cond, amount=.04)
d$y <- d$distance_error
d$x <- d$cond

fig_full <- ggplot(data = d, aes(y = y)) +
  
   #Add geom_() objects
   geom_point(data = d %>% filter(x =="1"), aes(x = xj), color = 'dodgerblue', size = 1.5, 
              alpha = .6) +
   geom_point(data = d %>% filter(x =="2"), aes(x = xj), color = 'darkorange', size = 1.5, 
              alpha = .6) +
   geom_point(data = d %>% filter(x =="3"), aes(x = xj), color = 'dodgerblue', size = 1.5, 
              alpha = .6) + 
   geom_point(data = d %>% filter(x =="4"), aes(x = xj), color = 'darkorange', size = 1.5, 
              alpha = .6) +
   geom_line(aes(x = xj, group = ID), color = 'lightgray', alpha = .3) +
   geom_line(aes(x = xj, group = ID), color = 'lightgray', alpha = .3) +
  
   geom_half_boxplot(
     data = d %>% filter(x=="1"), aes(x=x, y = y), position = position_nudge(x = -.35), 
     side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
     fill = 'dodgerblue', alpha = .6) +
   
   geom_half_boxplot(
     data = d %>% filter(x=="2"), aes(x=x, y = y), position = position_nudge(x = -1.16), 
     side = "l",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
     fill = 'darkorange', alpha = .6) +
  
   geom_half_boxplot(
     data = d %>% filter(x=="3"), aes(x=x, y = y), position = position_nudge(x = 1.3), 
     side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
     fill = 'dodgerblue', alpha = .6) +
   
   geom_half_boxplot(
     data = d %>% filter(x=="4"), aes(x=x, y = y), position = position_nudge(x = .2), 
     side = "r",outlier.shape = NA, center = TRUE, errorbar.draw = FALSE, width = .2, 
     fill = 'darkorange', alpha = .6) +
  
   geom_half_violin(
     data = d %>% filter(x=="1"),aes(x = x, y = y), position = position_nudge(x = -.40), 
     side = "l", fill = 'dodgerblue', alpha = .6) +
 
   geom_half_violin(
     data = d %>% filter(x=="2"),aes(x = x, y = y), position = position_nudge(x = -1.40), 
     side = "l", fill = "darkorange", alpha = .6) +
  
   geom_half_violin(
     data = d %>% filter(x=="3"),aes(x = x, y = y), position = position_nudge(x = 1.45), 
     side = "r", fill = 'dodgerblue', alpha = .6) +
 
   geom_half_violin(
     data = d %>% filter(x=="4"),aes(x = x, y = y), position = position_nudge(x = .45), 
     side = "r", fill = "darkorange", alpha = .6) + 
  
   #Define additional settings
   scale_x_continuous(breaks=c(1,2,3,4), labels=c("Before", "After","Before", "After"), 
                      limits=c(0, 5))+
   xlab("Condition") + ylab("Value") +
   ggtitle('Figure 8: 2 x 2 Repeated measures with box- and violin plots') +
   theme_classic()+
   coord_cartesian(ylim=c(min(d$distance_error), max(d$distance_error)))

fig_full

```

